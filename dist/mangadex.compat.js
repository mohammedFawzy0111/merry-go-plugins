"use strict";function _regenerator(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var e,t,r="function"==typeof Symbol?Symbol:{},n=r.iterator||"@@iterator",o=r.toStringTag||"@@toStringTag";function i(r,n,o,i){var c=n&&n.prototype instanceof Generator?n:Generator,u=Object.create(c.prototype);return _regeneratorDefine(u,"_invoke",function(r,n,o){var i,c,u,f=0,p=o||[],y=!1,G={p:0,n:0,v:e,a:d,f:d.bind(e,4),d:function(t,r){return i=t,c=0,u=e,G.n=r,a}};function d(r,n){for(c=r,u=n,t=0;!y&&f&&!o&&t<p.length;t++){var o,i=p[t],d=G.p,l=i[2];r>3?(o=l===n)&&(u=i[(c=i[4])?5:(c=3,3)],i[4]=i[5]=e):i[0]<=d&&((o=r<2&&d<i[1])?(c=0,G.v=n,G.n=i[1]):d<l&&(o=r<3||i[0]>n||n>l)&&(i[4]=r,i[5]=n,G.n=l,c=0))}if(o||r>1)return a;throw y=!0,n}return function(o,p,l){if(f>1)throw TypeError("Generator is already running");for(y&&1===p&&d(p,l),c=p,u=l;(t=c<2?e:u)||!y;){i||(c?c<3?(c>1&&(G.n=-1),d(c,u)):G.n=u:G.v=u);try{if(f=2,i){if(c||(o="next"),t=i[o]){if(!(t=t.call(i,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,c<2&&(c=0)}else 1===c&&(t=i.return)&&t.call(i),c<2&&(u=TypeError("The iterator does not provide a '"+o+"' method"),c=1);i=e}else if((t=(y=G.n<0)?u:r.call(n,G))!==a)break}catch(t){i=e,c=1,u=t}finally{f=1}}return{value:t,done:y}}}(r,o,i),!0),u}var a={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}t=Object.getPrototypeOf;var c=[][n]?t(t([][n]())):(_regeneratorDefine(t={},n,function(){return this}),t),u=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(c);function f(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,GeneratorFunctionPrototype):(e.__proto__=GeneratorFunctionPrototype,_regeneratorDefine(e,o,"GeneratorFunction")),e.prototype=Object.create(u),e}return GeneratorFunction.prototype=GeneratorFunctionPrototype,_regeneratorDefine(u,"constructor",GeneratorFunctionPrototype),_regeneratorDefine(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName="GeneratorFunction",_regeneratorDefine(GeneratorFunctionPrototype,o,"GeneratorFunction"),_regeneratorDefine(u),_regeneratorDefine(u,o,"Generator"),_regeneratorDefine(u,n,function(){return this}),_regeneratorDefine(u,"toString",function(){return"[object Generator]"}),(_regenerator=function(){return{w:i,m:f}})()}function _regeneratorDefine(e,r,n,t){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}_regeneratorDefine=function(e,r,n,t){function o(r,n){_regeneratorDefine(e,r,function(e){return this._invoke(r,n,e)})}r?i?i(e,r,{value:n,enumerable:!t,configurable:!t,writable:!t}):e[r]=n:(o("next",0),o("throw",1),o("return",2))},_regeneratorDefine(e,r,n,t)}function asyncGeneratorStep(n,t,e,r,o,a,c){try{var i=n[a](c),u=i.value}catch(n){return void e(n)}i.done?t(u):Promise.resolve(u).then(r,o)}function _asyncToGenerator(n){return function(){var t=this,e=arguments;return new Promise(function(r,o){var a=n.apply(t,e);function _next(n){asyncGeneratorStep(a,r,o,_next,_throw,"next",n)}function _throw(n){asyncGeneratorStep(a,r,o,_next,_throw,"throw",n)}_next(void 0)})}}const API="https://api.mangadex.org";const CDN="https://uploads.mangadex.org";const MANGA_DEX_HEADERS={"Content-Type":"application/json",Accept:"application/json"};const limit=20;const mangaDex=sandbox.utils.createSource({name:"MangaDex",baseUrl:API,icon:"https://mangadex.org/favicon.ico"});const getChapters=function(){var _ref=_asyncToGenerator(_regenerator().m(function _callee(mangaId){var chapters,offset,limit,total,chaptersResp,chapterData;return _regenerator().w(function(_context){while(1)switch(_context.n){case 0:chapters=[];offset=0;limit=100;total=0;case 1:_context.n=2;return sandbox.http.get(`${API}/chapter`,{headers:MANGA_DEX_HEADERS,params:{manga:mangaId,translatedLanguage:["en","ar"],order:{chapter:"asc"},limit:limit,offset:offset}});case 2:chaptersResp=_context.v;chapterData=chaptersResp.data.data;total=chaptersResp.data.total;chapters=chapters.concat(chapterData.map(ch=>{const chapterNum=Number(ch.attributes.chapter)||0;const chapterUrl=`${API}/chapter/${ch.id}`;return sandbox.utils.createChapter({number:chapterNum,url:chapterUrl,title:ch.attributes.title||`Chapter ${chapterNum}`,manga:`${API}/manga/${mangaId}`,publishedAt:ch.attributes.publishAt||(new Date).toISOString(),pages:[]})}));offset+=limit;case 3:if(offset<total){_context.n=1;break}case 4:return _context.a(2,chapters)}},_callee)}));return function getChapters(_x){return _ref.apply(this,arguments)}}();const getRating=function(){var _ref2=_asyncToGenerator(_regenerator().m(function _callee2(mangaId){var _Number;var response,id;return _regenerator().w(function(_context2){while(1)switch(_context2.n){case 0:_context2.n=1;return sandbox.http.get(`${API}/statistics/manga/${mangaId}`,{headers:MANGA_DEX_HEADERS});case 1:response=_context2.v;id=Object.keys(response.data.statistics)[0];return _context2.a(2,(_Number=Number(response.data.statistics[id].rating.average))!==null&&_Number!==void 0?_Number:0)}},_callee2)}));return function getRating(_x2){return _ref2.apply(this,arguments)}}();const getBestTitle=attributes=>{if(attributes.title&&attributes.title["en"])return attributes.title["en"];if(attributes.title&&attributes.title["ar"])return attributes.title["ar"];if(attributes.title&&attributes.title["ja"])return attributes.title["ja"];if(attributes.altTitles){const englishAltTitle=attributes.altTitles.find(titleObj=>titleObj["en"]);if(englishAltTitle!==null&&englishAltTitle!==void 0&&englishAltTitle["en"])return englishAltTitle["en"];const firstAltTitle=attributes.altTitles.find(titleObj=>{const values=Object.values(titleObj);return values.length>0&&values[0]});if(firstAltTitle)return Object.values(firstAltTitle)[0]}return"Unknown"};mangaDex.fetchRecentManga=function(){var _ref3=_asyncToGenerator(_regenerator().m(function _callee4(offset){var response,mangas,_t;return _regenerator().w(function(_context4){while(1)switch(_context4.p=_context4.n){case 0:_context4.p=0;_context4.n=1;return sandbox.http.get(`${API}/manga`,{headers:MANGA_DEX_HEADERS,params:{limit:limit,offset:offset,"order[updatedAt]":"desc",includes:["cover_art"]}});case 1:response=_context4.v;_context4.n=2;return Promise.all(response.data.data.map(function(){var _ref4=_asyncToGenerator(_regenerator().m(function _callee3(item){var _coverRel$attributes;var attributes,title,url,id,coverRel,imageUrl,lastChapter,lastUpdated;return _regenerator().w(function(_context3){while(1)switch(_context3.n){case 0:attributes=item.attributes;title=getBestTitle(attributes);url=`${API}/manga/${item.id}`;id=item.id||`${title} + ${url}`;coverRel=item.relationships.find(rel=>rel.type==="cover_art");imageUrl="";if(coverRel!==null&&coverRel!==void 0&&(_coverRel$attributes=coverRel.attributes)!==null&&_coverRel$attributes!==void 0&&_coverRel$attributes.fileName){imageUrl=`${CDN}/covers/${item.id}/${coverRel.attributes.fileName}.256.jpg`}lastChapter=attributes.lastChapter||"no chapters";lastUpdated=attributes.updatedAt||(new Date).toISOString();return _context3.a(2,sandbox.utils.createManga({id:id,name:title,url:url,imageUrl:imageUrl,lastChapter:lastChapter,lastUpdated:lastUpdated,source:mangaDex}))}},_callee3)}));return function(_x4){return _ref4.apply(this,arguments)}}()));case 2:mangas=_context4.v;return _context4.a(2,mangas);case 3:_context4.p=3;_t=_context4.v;sandbox.console.error("Error fetching recent manga:",_t);return _context4.a(2,[])}},_callee4,null,[[0,3]])}));return function(_x3){return _ref3.apply(this,arguments)}}();mangaDex.fetchPopularManga=function(){var _ref5=_asyncToGenerator(_regenerator().m(function _callee6(offset){var response,mangas,_t2;return _regenerator().w(function(_context6){while(1)switch(_context6.p=_context6.n){case 0:_context6.p=0;_context6.n=1;return sandbox.http.get(`${API}/manga`,{headers:MANGA_DEX_HEADERS,params:{limit:limit,offset:offset,"order[followedCount]":"desc",includes:["cover_art"]}});case 1:response=_context6.v;_context6.n=2;return Promise.all(response.data.data.map(function(){var _ref6=_asyncToGenerator(_regenerator().m(function _callee5(item){var _coverRel$attributes2;var attributes,title,url,id,coverRel,imageUrl,lastChapter,lastUpdated;return _regenerator().w(function(_context5){while(1)switch(_context5.n){case 0:attributes=item.attributes;title=getBestTitle(attributes);url=`${API}/manga/${item.id}`;id=item.id||`${title} + ${url}`;coverRel=item.relationships.find(rel=>rel.type==="cover_art");imageUrl="";if(coverRel!==null&&coverRel!==void 0&&(_coverRel$attributes2=coverRel.attributes)!==null&&_coverRel$attributes2!==void 0&&_coverRel$attributes2.fileName){imageUrl=`${CDN}/covers/${item.id}/${coverRel.attributes.fileName}.256.jpg`}lastChapter=attributes.lastChapter||"no chapters";lastUpdated=attributes.updatedAt||(new Date).toISOString();return _context5.a(2,sandbox.utils.createManga({id:id,name:title,url:url,imageUrl:imageUrl,lastChapter:lastChapter,lastUpdated:lastUpdated,source:mangaDex}))}},_callee5)}));return function(_x6){return _ref6.apply(this,arguments)}}()));case 2:mangas=_context6.v;return _context6.a(2,mangas);case 3:_context6.p=3;_t2=_context6.v;sandbox.console.error("Error fetching popular manga:",_t2);return _context6.a(2,[])}},_callee6,null,[[0,3]])}));return function(_x5){return _ref5.apply(this,arguments)}}();mangaDex.fetchMangaDetails=function(){var _ref7=_asyncToGenerator(_regenerator().m(function _callee7(mangaUrl){var _mangaData$attributes,_mangaData$attributes2,_mangaData$relationsh,_mangaData$relationsh2,response,mangaData,title,coverUrl,coverRel,coverResponse,fileName,lastChapter,lastUpdated,details,chapters,_t3,_t4,_t5,_t6,_t7,_t8,_t9,_t0,_t1,_t10,_t11;return _regenerator().w(function(_context7){while(1)switch(_context7.p=_context7.n){case 0:_context7.p=0;_context7.n=1;return sandbox.http.get(mangaUrl,{headers:MANGA_DEX_HEADERS,params:{includes:["cover_art","author","artist"]}});case 1:response=_context7.v;mangaData=response.data.data;title=getBestTitle(mangaData.attributes);coverUrl="";coverRel=mangaData.relationships.find(rel=>rel.type==="cover_art");if(!(coverRel!==null&&coverRel!==void 0&&coverRel.id)){_context7.n=3;break}_context7.n=2;return sandbox.http.get(`${API}/cover/${coverRel.id}`);case 2:coverResponse=_context7.v;fileName=coverResponse.data.data.attributes.fileName;coverUrl=`${CDN}/covers/${mangaData.id}/${fileName}.256.jpg`;case 3:lastChapter=mangaData.attributes.lastChapter||"no chapters";lastUpdated=mangaData.attributes.updatedAt||(new Date).toISOString();_t3=mangaData.attributes.altTitles?mangaData.attributes.altTitles.map(titleObj=>{const firstValue=Object.values(titleObj)[0];return firstValue||""}).filter(Boolean):[];_t4=mangaData.attributes.status||"Unknown";_t5=((_mangaData$attributes=mangaData.attributes.description)===null||_mangaData$attributes===void 0?void 0:_mangaData$attributes.en)||"";_t6=mangaData.attributes.originalLanguage||"en";_t7=mangaData.attributes.publicationDemographic||"Unknown";_t8=mangaData.attributes.year||"Unknown";_t9=((_mangaData$attributes2=mangaData.attributes.tags)===null||_mangaData$attributes2===void 0?void 0:_mangaData$attributes2.map(tag=>tag.attributes.name.en))||[];_t0=((_mangaData$relationsh=mangaData.relationships.find(rel=>rel.type==="author"))===null||_mangaData$relationsh===void 0||(_mangaData$relationsh=_mangaData$relationsh.attributes)===null||_mangaData$relationsh===void 0?void 0:_mangaData$relationsh.name)||"Unknown Author";_t1=((_mangaData$relationsh2=mangaData.relationships.find(rel=>rel.type==="artist"))===null||_mangaData$relationsh2===void 0||(_mangaData$relationsh2=_mangaData$relationsh2.attributes)===null||_mangaData$relationsh2===void 0?void 0:_mangaData$relationsh2.name)||"Unknown Artist";_context7.n=4;return getRating(mangaData.id);case 4:_t10=_context7.v;details={altTitles:_t3,status:_t4,description:_t5,"original language":_t6,Demographic:_t7,year:_t8,tags:_t9,author:_t0,artist:_t1,rating:_t10};_context7.n=5;return getChapters(mangaData.id);case 5:chapters=_context7.v;return _context7.a(2,sandbox.utils.createManga({id:mangaData.id||`${title} + ${mangaUrl}`,name:title,url:mangaUrl,imageUrl:coverUrl,lastChapter:lastChapter,lastUpdated:lastUpdated,source:mangaDex,data:details,chapters:chapters}));case 6:_context7.p=6;_t11=_context7.v;sandbox.console.error("Error fetching manga details:",_t11);return _context7.a(2,sandbox.utils.createManga({id:"",name:"Unknown",url:mangaUrl,imageUrl:"",lastChapter:"N/A",lastUpdated:(new Date).toISOString(),source:mangaDex,data:{},chapters:[]}))}},_callee7,null,[[0,6]])}));return function(_x7){return _ref7.apply(this,arguments)}}();mangaDex.fetchChapterDetails=function(){var _ref8=_asyncToGenerator(_regenerator().m(function _callee8(url){var _chapterData$relation,chapterReq,chapterData,mangaId,title,chapterNum,chapterId,publishedAt,atHomeResp,baseUrl,hash,fileNames,pages,_t12;return _regenerator().w(function(_context8){while(1)switch(_context8.p=_context8.n){case 0:_context8.p=0;_context8.n=1;return sandbox.http.get(url,{headers:MANGA_DEX_HEADERS});case 1:chapterReq=_context8.v;chapterData=chapterReq.data.data;mangaId=((_chapterData$relation=chapterData.relationships.find(rel=>rel.type==="manga"))===null||_chapterData$relation===void 0?void 0:_chapterData$relation.id)||"";title=chapterData.attributes.title||"";chapterNum=Number(chapterData.attributes.chapter)||0;chapterId=chapterData.id;publishedAt=chapterData.attributes.publishAt||(new Date).toISOString();_context8.n=2;return sandbox.http.get(`${API}/at-home/server/${chapterId}`,{headers:MANGA_DEX_HEADERS});case 2:atHomeResp=_context8.v;baseUrl=atHomeResp.data.baseUrl;hash=atHomeResp.data.chapter.hash;fileNames=atHomeResp.data.chapter.data||[];pages=fileNames.map(name=>`${baseUrl}/data/${hash}/${name}`);return _context8.a(2,sandbox.utils.createChapter({manga:`${API}/manga/${mangaId}`,title:title,number:chapterNum,url:url,publishedAt:publishedAt,pages:pages}));case 3:_context8.p=3;_t12=_context8.v;sandbox.console.error("Error fetching chapter:",_t12);return _context8.a(2,sandbox.utils.createChapter({manga:"",number:0,url:url,pages:[]}))}},_callee8,null,[[0,3]])}));return function(_x8){return _ref8.apply(this,arguments)}}();const tagCache=new Map;mangaDex.fetchSearchResults=function(){var _ref9=_asyncToGenerator(_regenerator().m(function _callee9(query,offset){var isTagSearch,params,tagName,tagResponse,allTags,response,searchResults,mangas,result,_coverRel$attributes3,mangaId,name,url,coverRel,coverFileName,coverUrl,lastChapter,lastUpdated,_t13;return _regenerator().w(function(_context9){while(1)switch(_context9.p=_context9.n){case 0:_context9.p=0;isTagSearch=query.startsWith("[")&&query.endsWith("]");params={limit:limit,offset:offset,includes:["cover_art"],availableTranslatedLanguage:["en","ar"],"order[followedCount]":"desc"};if(!isTagSearch){_context9.n=5;break}tagName=query.slice(1,-1).trim().toLowerCase();if(!tagCache.has(tagName)){_context9.n=1;break}params.includedTags=[tagCache.get(tagName)];_context9.n=4;break;case 1:_context9.n=2;return sandbox.http.get(`${API}/manga/tag`);case 2:tagResponse=_context9.v;allTags=tagResponse.data.data;allTags.forEach(tag=>{const name=tag.attributes.name.en.toLowerCase();tagCache.set(name,tag.id)});if(!tagCache.has(tagName)){_context9.n=3;break}params.includedTags=[tagCache.get(tagName)];_context9.n=4;break;case 3:return _context9.a(2,[]);case 4:_context9.n=6;break;case 5:params.title=query;case 6:_context9.n=7;return sandbox.http.get(`${API}/manga`,{headers:MANGA_DEX_HEADERS,params:params});case 7:response=_context9.v;searchResults=response.data.data;mangas=[];for(result of searchResults){mangaId=result.id;name=getBestTitle(result.attributes);url=`${API}/manga/${mangaId}`;coverRel=result.relationships.find(rel=>rel.type==="cover_art");coverFileName=coverRel===null||coverRel===void 0||(_coverRel$attributes3=coverRel.attributes)===null||_coverRel$attributes3===void 0?void 0:_coverRel$attributes3.fileName;coverUrl=coverFileName?`${CDN}/covers/${mangaId}/${coverFileName}.256.jpg`:"";lastChapter=result.attributes.lastChapter||"no chapters";lastUpdated=result.attributes.updatedAt||(new Date).toISOString();mangas.push(sandbox.utils.createManga({id:mangaId,name:name,url:url,imageUrl:coverUrl,source:mangaDex,lastChapter:lastChapter,lastUpdated:lastUpdated}))}return _context9.a(2,mangas);case 8:_context9.p=8;_t13=_context9.v;sandbox.console.error("Error fetching search results:",_t13);return _context9.a(2,[])}},_callee9,null,[[0,8]])}));return function(_x9,_x0){return _ref9.apply(this,arguments)}}();module.exports=mangaDex;