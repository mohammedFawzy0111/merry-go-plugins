function _await(value,then,direct){if(direct){return then?then(value):value}if(!value||!value.then){value=Promise.resolve(value)}return then?value.then(then):value}function _settle(pact,state,value){if(!pact.s){if(value instanceof _Pact){if(value.s){if(state&1){state=value.s}value=value.v}else{value.o=_settle.bind(null,pact,state);return}}if(value&&value.then){value.then(_settle.bind(null,pact,state),_settle.bind(null,pact,2));return}pact.s=state;pact.v=value;var observer=pact.o;if(observer){observer(pact)}}}var _Pact=function(){function _Pact(){}_Pact.prototype.then=function(onFulfilled,onRejected){var result=new _Pact;var state=this.s;if(state){var callback=state&1?onFulfilled:onRejected;if(callback){try{_settle(result,1,callback(this.v))}catch(e){_settle(result,2,e)}return result}else{return this}}this.o=function(_this){try{var value=_this.v;if(_this.s&1){_settle(result,1,onFulfilled?onFulfilled(value):value)}else if(onRejected){_settle(result,1,onRejected(value))}else{_settle(result,2,value)}}catch(e){_settle(result,2,e)}};return result};return _Pact}();function _isSettledPact(thenable){return thenable instanceof _Pact&&thenable.s&1}function _do(body,test){var awaitBody;do{var result=body();if(result&&result.then){if(_isSettledPact(result)){result=result.v}else{awaitBody=true;break}}var shouldContinue=test();if(_isSettledPact(shouldContinue)){shouldContinue=shouldContinue.v}if(!shouldContinue){return result}}while(!shouldContinue.then);var pact=new _Pact;var reject=_settle.bind(null,pact,2);(awaitBody?result.then(_resumeAfterBody):shouldContinue.then(_resumeAfterTest)).then(void 0,reject);return pact;function _resumeAfterBody(value){result=value;for(;;){shouldContinue=test();if(_isSettledPact(shouldContinue)){shouldContinue=shouldContinue.v}if(!shouldContinue){break}if(shouldContinue.then){shouldContinue.then(_resumeAfterTest).then(void 0,reject);return}result=body();if(result&&result.then){if(_isSettledPact(result)){result=result.v}else{result.then(_resumeAfterBody).then(void 0,reject);return}}}_settle(pact,1,result)}function _resumeAfterTest(shouldContinue){if(shouldContinue){do{result=body();if(result&&result.then){if(_isSettledPact(result)){result=result.v}else{result.then(_resumeAfterBody).then(void 0,reject);return}}shouldContinue=test();if(_isSettledPact(shouldContinue)){shouldContinue=shouldContinue.v}if(!shouldContinue){_settle(pact,1,result);return}}while(!shouldContinue.then);shouldContinue.then(_resumeAfterTest).then(void 0,reject)}else{_settle(pact,1,result)}}}function _continue(value,then){return value&&value.then?value.then(then):then(value)}function _async(f){return function(){for(var args=[],i=0;i<arguments.length;i++){args[i]=arguments[i]}try{return Promise.resolve(f.apply(this,args))}catch(e){return Promise.reject(e)}}}function _catch(body,recover){try{var result=body()}catch(e){return recover(e)}if(result&&result.then){return result.then(void 0,recover)}return result}function _invoke(body,then){var result=body();if(result&&result.then){return result.then(then)}return then(result)}function _createForOfIteratorHelper(r,e){var t="undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=_unsupportedIterableToArray(r))||e&&r&&"number"==typeof r.length){t&&(r=t);var _n=0,F=function F(){};return{s:F,n:function n(){return _n>=r.length?{done:!0}:{done:!1,value:r[_n++]}},e:function e(r){throw r},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,u=!1;return{s:function s(){t=t.call(r)},n:function n(){var r=t.next();return a=r.done,r},e:function e(r){u=!0,o=r},f:function f(){try{a||null==t.return||t.return()}finally{if(u)throw o}}}}function _unsupportedIterableToArray(r,a){if(r){if("string"==typeof r)return _arrayLikeToArray(r,a);var t={}.toString.call(r).slice(8,-1);return"Object"===t&&r.constructor&&(t=r.constructor.name),"Map"===t||"Set"===t?Array.from(r):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(r,a):void 0}}function _arrayLikeToArray(r,a){(null==a||a>r.length)&&(a=r.length);for(var e=0,n=Array(a);e<a;e++)n[e]=r[e];return n}var API="https://api.mangadex.org";var CDN="https://uploads.mangadex.org";var MANGA_DEX_HEADERS={"Content-Type":"application/json",Accept:"application/json"};var limit=20;var mangaDex=sandbox.utils.createSource({name:"MangaDex",baseUrl:API,icon:"https://mangadex.org/favicon.ico"});var getChapters=_async(function(mangaId){var chapters=[];var offset=0;var limit=100;var total=0;return _continue(_do(function(){return _await(sandbox.http.get("".concat(API,"/chapter"),{headers:MANGA_DEX_HEADERS,params:{manga:mangaId,translatedLanguage:["en","ar"],order:{chapter:"asc"},limit:limit,offset:offset}}),function(chaptersResp){var chapterData=chaptersResp.data.data;total=chaptersResp.data.total;chapters=chapters.concat(chapterData.map(function(ch){var chapterNum=Number(ch.attributes.chapter)||0;var chapterUrl="".concat(API,"/chapter/").concat(ch.id);return sandbox.utils.createChapter({number:chapterNum,url:chapterUrl,title:ch.attributes.title||"Chapter ".concat(chapterNum),manga:"".concat(API,"/manga/").concat(mangaId),publishedAt:ch.attributes.publishAt||(new Date).toISOString(),pages:[]})}));offset+=limit})},function(){return offset<total}),function(){return chapters})});var getRating=_async(function(mangaId){return _await(sandbox.http.get("".concat(API,"/statistics/manga/").concat(mangaId),{headers:MANGA_DEX_HEADERS}),function(response){var _Number;var id=Object.keys(response.data.statistics)[0];return(_Number=Number(response.data.statistics[id].rating.average))!==null&&_Number!==void 0?_Number:0})});var getBestTitle=function getBestTitle(attributes){if(attributes.title&&attributes.title["en"])return attributes.title["en"];if(attributes.title&&attributes.title["ar"])return attributes.title["ar"];if(attributes.title&&attributes.title["ja"])return attributes.title["ja"];if(attributes.altTitles){var englishAltTitle=attributes.altTitles.find(function(titleObj){return titleObj["en"]});if(englishAltTitle!==null&&englishAltTitle!==void 0&&englishAltTitle["en"])return englishAltTitle["en"];var firstAltTitle=attributes.altTitles.find(function(titleObj){var values=Object.values(titleObj);return values.length>0&&values[0]});if(firstAltTitle)return Object.values(firstAltTitle)[0]}return"Unknown"};mangaDex.fetchRecentManga=_async(function(offset){return _catch(function(){return _await(sandbox.http.get("".concat(API,"/manga"),{headers:MANGA_DEX_HEADERS,params:{limit:limit,offset:offset,"order[updatedAt]":"desc",includes:["cover_art"]}}),function(response){return _await(Promise.all(response.data.data.map(_async(function(item){var _coverRel$attributes;var attributes=item.attributes;var title=getBestTitle(attributes);var url="".concat(API,"/manga/").concat(item.id);var id=item.id||"".concat(title," + ").concat(url);var coverRel=item.relationships.find(function(rel){return rel.type==="cover_art"});var imageUrl="";if(coverRel!==null&&coverRel!==void 0&&(_coverRel$attributes=coverRel.attributes)!==null&&_coverRel$attributes!==void 0&&_coverRel$attributes.fileName){imageUrl="".concat(CDN,"/covers/").concat(item.id,"/").concat(coverRel.attributes.fileName,".256.jpg")}var lastChapter=attributes.lastChapter||"no chapters";var lastUpdated=attributes.updatedAt||(new Date).toISOString();return sandbox.utils.createManga({id:id,name:title,url:url,imageUrl:imageUrl,lastChapter:lastChapter,lastUpdated:lastUpdated,source:mangaDex})}))))})},function(error){sandbox.console.error("Error fetching recent manga:",error);return[]})});mangaDex.fetchPopularManga=_async(function(offset){return _catch(function(){return _await(sandbox.http.get("".concat(API,"/manga"),{headers:MANGA_DEX_HEADERS,params:{limit:limit,offset:offset,"order[followedCount]":"desc",includes:["cover_art"]}}),function(response){return _await(Promise.all(response.data.data.map(_async(function(item){var _coverRel$attributes2;var attributes=item.attributes;var title=getBestTitle(attributes);var url="".concat(API,"/manga/").concat(item.id);var id=item.id||"".concat(title," + ").concat(url);var coverRel=item.relationships.find(function(rel){return rel.type==="cover_art"});var imageUrl="";if(coverRel!==null&&coverRel!==void 0&&(_coverRel$attributes2=coverRel.attributes)!==null&&_coverRel$attributes2!==void 0&&_coverRel$attributes2.fileName){imageUrl="".concat(CDN,"/covers/").concat(item.id,"/").concat(coverRel.attributes.fileName,".256.jpg")}var lastChapter=attributes.lastChapter||"no chapters";var lastUpdated=attributes.updatedAt||(new Date).toISOString();return sandbox.utils.createManga({id:id,name:title,url:url,imageUrl:imageUrl,lastChapter:lastChapter,lastUpdated:lastUpdated,source:mangaDex})}))))})},function(error){sandbox.console.error("Error fetching popular manga:",error);return[]})});mangaDex.fetchMangaDetails=_async(function(mangaUrl){return _catch(function(){return _await(sandbox.http.get(mangaUrl,{headers:MANGA_DEX_HEADERS,params:{includes:["cover_art","author","artist"]}}),function(response){var mangaData=response.data.data;var title=getBestTitle(mangaData.attributes);var coverUrl="";var coverRel=mangaData.relationships.find(function(rel){return rel.type==="cover_art"});return _invoke(function(){if(coverRel!==null&&coverRel!==void 0&&coverRel.id){return _await(sandbox.http.get("".concat(API,"/cover/").concat(coverRel.id)),function(coverResponse){var fileName=coverResponse.data.data.attributes.fileName;coverUrl="".concat(CDN,"/covers/").concat(mangaData.id,"/").concat(fileName,".256.jpg")})}},function(){var _mangaData$relationsh,_mangaData$relationsh2,_mangaData$attributes,_mangaData$attributes2;var lastChapter=mangaData.attributes.lastChapter||"no chapters";var lastUpdated=mangaData.attributes.updatedAt||(new Date).toISOString();var _temp9=((_mangaData$relationsh=mangaData.relationships.find(function(rel){return rel.type==="artist"}))===null||_mangaData$relationsh===void 0||(_mangaData$relationsh=_mangaData$relationsh.attributes)===null||_mangaData$relationsh===void 0?void 0:_mangaData$relationsh.name)||"Unknown Artist",_temp8=((_mangaData$relationsh2=mangaData.relationships.find(function(rel){return rel.type==="author"}))===null||_mangaData$relationsh2===void 0||(_mangaData$relationsh2=_mangaData$relationsh2.attributes)===null||_mangaData$relationsh2===void 0?void 0:_mangaData$relationsh2.name)||"Unknown Author",_temp7=((_mangaData$attributes=mangaData.attributes.tags)===null||_mangaData$attributes===void 0?void 0:_mangaData$attributes.map(function(tag){return tag.attributes.name.en}))||[],_temp6=mangaData.attributes.year||"Unknown",_temp5=mangaData.attributes.publicationDemographic||"Unknown",_temp4=mangaData.attributes.originalLanguage||"en",_temp3=((_mangaData$attributes2=mangaData.attributes.description)===null||_mangaData$attributes2===void 0?void 0:_mangaData$attributes2.en)||"",_temp2=mangaData.attributes.status||"Unknown",_temp=mangaData.attributes.altTitles?mangaData.attributes.altTitles.map(function(titleObj){var firstValue=Object.values(titleObj)[0];return firstValue||""}).filter(Boolean):[];return _await(getRating(mangaData.id),function(_getRating){var details={altTitles:_temp,status:_temp2,description:_temp3,"original language":_temp4,Demographic:_temp5,year:_temp6,tags:_temp7,author:_temp8,artist:_temp9,rating:_getRating};return _await(getChapters(mangaData.id),function(chapters){return sandbox.utils.createManga({id:mangaData.id||"".concat(title," + ").concat(mangaUrl),name:title,url:mangaUrl,imageUrl:coverUrl,lastChapter:lastChapter,lastUpdated:lastUpdated,source:mangaDex,data:details,chapters:chapters})})})})})},function(error){sandbox.console.error("Error fetching manga details:",error);return sandbox.utils.createManga({id:"",name:"Unknown",url:mangaUrl,imageUrl:"",lastChapter:"N/A",lastUpdated:(new Date).toISOString(),source:mangaDex,data:{},chapters:[]})})});mangaDex.fetchChapterDetails=_async(function(url){return _catch(function(){return _await(sandbox.http.get(url,{headers:MANGA_DEX_HEADERS}),function(chapterReq){var _chapterData$relation;var chapterData=chapterReq.data.data;var mangaId=((_chapterData$relation=chapterData.relationships.find(function(rel){return rel.type==="manga"}))===null||_chapterData$relation===void 0?void 0:_chapterData$relation.id)||"";var title=chapterData.attributes.title||"";var chapterNum=Number(chapterData.attributes.chapter)||0;var chapterId=chapterData.id;var publishedAt=chapterData.attributes.publishAt||(new Date).toISOString();return _await(sandbox.http.get("".concat(API,"/at-home/server/").concat(chapterId),{headers:MANGA_DEX_HEADERS}),function(atHomeResp){var baseUrl=atHomeResp.data.baseUrl;var hash=atHomeResp.data.chapter.hash;var fileNames=atHomeResp.data.chapter.data||[];var pages=fileNames.map(function(name){return"".concat(baseUrl,"/data/").concat(hash,"/").concat(name)});return sandbox.utils.createChapter({manga:"".concat(API,"/manga/").concat(mangaId),title:title,number:chapterNum,url:url,publishedAt:publishedAt,pages:pages})})})},function(error){sandbox.console.error("Error fetching chapter:",error);return sandbox.utils.createChapter({manga:"",number:0,url:url,pages:[]})})});var tagCache=new Map;mangaDex.fetchSearchResults=_async(function(query,offset){var _exit=false;return _catch(function(){var isTagSearch=query.startsWith("[")&&query.endsWith("]");var params={limit:limit,offset:offset,includes:["cover_art"],availableTranslatedLanguage:["en","ar"],"order[followedCount]":"desc"};return _invoke(function(){if(isTagSearch){var tagName=query.slice(1,-1).trim().toLowerCase();return function(){if(tagCache.has(tagName)){params.includedTags=[tagCache.get(tagName)]}else{return _await(sandbox.http.get("".concat(API,"/manga/tag")),function(tagResponse){var allTags=tagResponse.data.data;allTags.forEach(function(tag){var name=tag.attributes.name.en.toLowerCase();tagCache.set(name,tag.id)});if(tagCache.has(tagName)){params.includedTags=[tagCache.get(tagName)]}else{var _temp0=[];_exit=true;return _temp0}})}}()}else{params.title=query}},function(_result2){return _exit?_result2:_await(sandbox.http.get("".concat(API,"/manga"),{headers:MANGA_DEX_HEADERS,params:params}),function(response){var searchResults=response.data.data;var mangas=[];var _iterator=_createForOfIteratorHelper(searchResults),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var _coverRel$attributes3;var result=_step.value;var mangaId=result.id;var name=getBestTitle(result.attributes);var url="".concat(API,"/manga/").concat(mangaId);var coverRel=result.relationships.find(function(rel){return rel.type==="cover_art"});var coverFileName=coverRel===null||coverRel===void 0||(_coverRel$attributes3=coverRel.attributes)===null||_coverRel$attributes3===void 0?void 0:_coverRel$attributes3.fileName;var coverUrl=coverFileName?"".concat(CDN,"/covers/").concat(mangaId,"/").concat(coverFileName,".256.jpg"):"";var lastChapter=result.attributes.lastChapter||"no chapters";var lastUpdated=result.attributes.updatedAt||(new Date).toISOString();mangas.push(sandbox.utils.createManga({id:mangaId,name:name,url:url,imageUrl:coverUrl,source:mangaDex,lastChapter:lastChapter,lastUpdated:lastUpdated}))}}catch(err){_iterator.e(err)}finally{_iterator.f()}return mangas})})},function(error){sandbox.console.error("Error fetching search results:",error);return[]})});module.exports=mangaDex;